# @package _global_

defaults:
  - override /callbacks: default
  - override /data: aneurysm_vessel_seg
  - override /model: aneurysm_vessel_seg_roi

tags: ["baseline"]

callbacks:
  model_checkpoint:
    monitor: "val/final_score"
    mode: "max"
  early_stopping:
    patience: ${trainer.max_epochs}
    monitor: "val/final_score"
    mode: "max"

optimized_metric: "test/final_score"
logger:
  wandb:
    project: "RSNA_aneurysm_vessel"
    name: fold${data.fold}
    group: ${experiment_name}

model:
  _target_: src.models.aneurysm_vessel_seg_roi_module.AneurysmVesselSegROILitModuleTransformer
  compile: true
  sphere_radius: 5
  scheduler:
    warmup_epochs: 4
    eta_min: 1e-5
  optimizer:
    lr: 1e-4
    weight_decay: 1e-2
  # optimize_config:
  #   mode: target_decay
  #   target_names: 
  #     - net._orig_mod.nnunet
  #   lr_base: ${model.optimizer.lr}
  #   lr_decay_coef: 0.1
  net:
    _target_: src.models.components.anet_roi_net.AneurysmRoiBackboneNnUNetTruncatedDecoder
    nnunet_model_dir: /workspace/logs/nnUNet_results/Dataset001_VesselSegmentation/RSNA2025Trainer_moreDAv6_1_SkeletonRecallTverskyBeta07__nnUNetResEncUNetMPlans__3d_fullres
    pretrained: true
    fold: all
    checkpoint_name: checkpoint_final.pth
    configuration: 3d_fullres
    out_channels: null
    sphere_mid_channels: 32
    num_truncate_stages: 1
  mask_pool_modes_loc: mean
  global_pool_modes_loc: mean
  mask_pool_modes_ap: mean
  global_pool_modes_ap: mean
  use_encoder_global_pooling_loc: true
  use_encoder_global_pooling_ap: true
  add_dilated_mask_loc: false
  add_dilated_mask_ap: false
  dilate_kernel: [1, 3, 3]
  dilate_iters: 1
  branch_norm: true
  proj_global_dim_loc: 64
  proj_mask_dim_loc: 32
  proj_global_dim_ap: 64
  proj_mask_dim_ap: 32
  transformer_embed_dim: 96
  # metadata_numeric_dim: 12
  # metadata_categorical_cardinalities: [3, 5, 3]
  ema: true
  ema_decay: 0.995
  ema_update_after_step: 100
  num_extra_mask_branches: 1
  distort_limit: 0.1
  w_loc: 0.1
  w_ap: 0.05
  w_sphere: 1.0

data:
  vessel_pred_dir: ${paths.data_dir}/nnUNet_inference/predictions_v4_margin15_30
  batch_size: 1
  input_size: [128, 256, 256]
  keep_ratio: z-xy
  metadata_root: ${paths.data_dir}/series_niix
  extra_seg_suffix: RSNA2025Trainer_moreDAv6_SkeletonRecallW3TverskyBeta07__nnUNetResEncUNetMPlans__3d_fullres
  include_metadata: false
  # metadata_numeric_dropout_prob: 0.1
  # metadata_categorical_dropout_prob: 0.1

trainer:
  max_epochs: 30
  accumulate_grad_batches: 8
  check_val_every_n_epoch: 1

experiment_name: 251013-seg_tf-v4-nnunet_truncate1_preV6_1-ex_dav6w3-m32g64-e30-w01_005_1-s128_256_256
